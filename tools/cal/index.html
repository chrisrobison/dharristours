<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='main.css' rel='stylesheet' />
<link href='/lib/css/tiny-date-picker.css' rel='stylesheet' />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src='/lib/js/tiny-date-picker.min.js'></script>
<script src='mycal.js'></script>
<style>

</style>
</head>
<body>
<div class='left'>
  <div id='tinycal'></div>
  <div id='details' class='tabs'>
      <ul>
        <li><a href="#joblist" class="active joblist">Jobs</a></li> 
        <li><a href="#detail" class='detail'>Details</a></li> 
      </ul>

      <div id='joblist'> </div>
      <div id='detail'> </div>
   </div>
</div>
  <div id='calendar'></div>
<script>
   
   var dp = TinyDatePicker('#tinycal', { 
      format(date) {
         return date.toLocaleDateString();
      },
      parse(str) {
          var date = new Date(str);
          return isNaN(date) ? new Date() : date;
      },
      mode: 'dp-permanent' 
   });

   dp.on('statechange', (_, picker) => { 
      console.log(picker.state.hilightedDate.toISOString()); 
      calendar.gotoDate(picker.state.hilightedDate.toISOString()); 

   } );
   var calendar, calendarEl;

   function doCalendar(exclude) {
      calendarEl = document.getElementById('calendar');

      calendar = new FullCalendar.Calendar(calendarEl, {
      plugins: [ 'interaction', 'resourceDayGrid', 'resourceTimeGrid' ],
      defaultView: 'resourceTimeGridDay',
      defaultDate: new Date().toISOString().substr(0, 10),
      editable: true,
      selectable: true,
      eventLimit: true, // allow "more" link when too many events
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'resourceTimeGridDay,resourceTimeGridTwoDay,timeGridWeek,dayGridMonth'
      },
      views: {
        resourceTimeGridTwoDay: {
          type: 'resourceTimeGrid',
          duration: { days: 2 },
          buttonText: '2 days',
        }
      },
      timeZone: "America/Los_Angeles",
      schedulerLicenseKey: '12345-fcs-67890',
      //// uncomment this line to hide the all-day slot
      allDaySlot: false,

      resources: {
         url: "api.php?type=resources"
      },
      events: {
         url: "api.php?type=events"
      },
      eventSourceSuccess: function(content, xhr) {
        console.log("eventSourceSuccess");
        console.dir(content);
        
        const jobs = document.querySelector("#joblist");
        var html = "<table class='jobs'><thead><tr><th>Job</th><th>Start</th><th>End</th><th>Link</th></tr></thead><tbody>";
        var sel = calendar.getDate(), rowclass='';
        sels = (new Date(calendar.getDate().toISOString().substr(0,10)).getTime()); 
        for (var i in content) { 
           id = (new Date(content[i].start).getTime());
           if ((id > sels) && (id < sels + 86400000)) {
               rowclass = "";
               if (content[i].title.match(/CANCELLED/i)) {
                  content[i].title = content[i].title.replace(/\s*CANCELLED\s*/, '');
                  rowclass = "cancelled";
               } else {
                  rowclass = "";
               }
               html += "<tr><td class='"+rowclass+"'>"+content[i].title+"</td><td class='"+rowclass+"'>"+cleanTime(content[i].start)+"</td><td class='"+rowclass+"'>"+cleanTime(content[i].end)+"</td><td><a target='_blank' href=\""+content[i].url+"\">&#128279;</a></td></tr>";
           }
        }
        html += "</tbody></table>";
        jobs.innerHTML = html;
        selectTab(document.querySelector("a[href='#joblist']")); 
        return content.eventArray;
      },
      select: function(arg) {
        console.log(
          'select',
          arg.startStr,
          arg.endStr,
          arg.resource ? arg.resource.id : '(no resource)'
        );
      },
      dateClick: function(arg) {
        console.log(
          'dateClick',
          arg.date,
          arg.resource ? arg.resource.id : '(no resource)'
        );
      },
      datesRender: function(arg) {
         dp.setState({"selectedDate": new Date(arg.view.currentStart.getTime())})
         console.log("datesRender");
         console.dir(arg);
      }
    });

    calendar.render();

   }

   function cleanTime(date) {
      var mydate = new Date(date);
      var hr = mydate.getHours();
      var xm = (hr < 12) ? "am" : "pm";
      hr = (hr > 12) ? hr - 12 : hr;
      if (hr == 0) {
         hr = 12;
      }
      var min = mydate.getMinutes();
      min = (min < 10) ? "0" + min : min;

      var mytime = hr+':'+min+xm;

      if (mytime == "12:00am") {
         mytime = "-";
      }
      return mytime;
   }

   function handleClick(who) { 
      
      makeRequest('GET', 'api.php?type=event&id='+who, function (err, datums) {
        myevent = JSON.parse(datums);
        console.dir(myevent);

        var out = "<table id='jobdetail'><tr><th>Job ID</th><td>" + myevent.JobID + "</td>";
        out += "<th>Passengers</th><td>" + ((myevent.NumberOfItems) ? myevent.NumberOfItems : "?") + "</td></tr>";
        out += "<tr><th>Job</th><td colspan='3'>"+myevent.Job+"</td></tr>";
        out += "<tr><th>Bus</th><td colspan='3'>" + mybuses[myevent.BusID].title + "</td></tr>";
        
        var driver = (myevent && myevent.EmployeeID && mydrivers && mydrivers[myevent.EmployeeID]) ? mydrivers[myevent.EmployeeID].Driver + " - " + mydrivers[myevent.EmployeeID].Phone : "Unassigned";
      
        out += "<tr><th>Driver</th><td colspan='3'>" + driver + "</td></tr>";
        out += "<tr><th>Pickup</th><td colspan='2'>"+ ((myevent.PickupLocation) ? myevent.PickupLocation : "") +"</td><td>" +myevent.PickupTime + "</td></tr>";
        out += "<tr><th>Dropoff</th><td colspan='2'>"+ ((myevent.DropOffLocation) ? myevent.DropOffLocation : "") +"</td><td>" +myevent.DropOffTime + "</td></tr>";
        if (myevent.finalDropOffLocation) {
         out += "<tr><th>Final</th><td colspan='2'>"+myevent.FinalDropOffLocation +"</td></tr>";
        }
        out += "</table>";

        document.querySelector("#detail").innerHTML = out;
        selectTab("#detail");
        if (err) { throw err; }
        console.log(datums);
      }); 
   } 
   function makeRequest (method, url, done) {
     var xhr = new XMLHttpRequest();
     xhr.open(method, url);
     xhr.onload = function () {
       done(null, xhr.response);
     };
     xhr.onerror = function () {
       done(xhr.response);
     };
     xhr.send();
   }
   function cleanTabs(selector) {
      var tab_lists_anchors = document.querySelectorAll(selector + " li a");
      var divs = document.querySelector(selector).getElementsByTagName("div");
      
      for (i = 0; i < divs.length; i++) {
          divs[i].style.display = "none";
      }

      for (i = 0; i < tab_lists_anchors.length; i++) {
          tab_lists_anchors[i].classList.remove("active");
      }
 
   }
   function selectTab(who) {
      cleanTabs(".tabs");
      if (typeof who === "string") {
         who = document.querySelector("a[href=\""+who+"\"]");
      }
      who.classList.add('active');
      div_to_show = who.getAttribute('href');
      document.querySelector(div_to_show).style.display = "block";

   }
function makeTabs(selector) {
    tab_lists_anchors = document.querySelectorAll(selector + " li a");
    divs = document.querySelector(selector).getElementsByTagName("div");
    
    for (var i = 0; i < tab_lists_anchors.length; i++) {
        if (tab_lists_anchors[i].classList.contains('active')) {
            divs[i].style.display = "block";
        }
 
    }
 
    for (i = 0; i < tab_lists_anchors.length; i++) {
        document.querySelectorAll(".tabs li a")[i].addEventListener('click', function(e) {
 
            cleanTabs(selector);
 
            clicked_tab = e.target || e.srcElement;
            selectTab(clicked_tab); 
        });
    }
}
function makeSettingsDropdown(resources) {
    var toolbar = document.querySelector(".fc-right .fc-button-group");

    if (toolbar) {
       var el = document.createElement('button');
       el.className = "dropdown fc-button-primary";
       el.style = "margin-left:.25rem;";      
       var btn = "<button id='settingButton' class='fc-button fc-button-primary dropdown-toggle' data-toggle='dropdown'>Buses</button>";
       /*
       var btn = document.createElement('button');
       btn.className = "btn btn-secondary dropdown-toggle";
       btn.type = "button";
       btn.id = "settingsButton";
       btn.dataToggle = "dropdown";
       btn.ariaHasPopup = true;
       btn.ariaExpanded = false;
       btn.innerHTML = '<span class="glyphicon glyphicon-cog" aria-hidden="true"></span>'; 
       el.appendChild(btn);
       */

       var list = document.createElement('div');
//       list.className = "dropdown-menu";
       var html = "<div class='dropdown-menu dropdown-menu-right'>";

       for (var i in resources) {
           html += "<a class='dropdown-item' href='#'><input type='checkbox' class='showbus_checkbox' id='showbus_" + resources[i].id + "' checked='true'> " + resources[i].title + "</a>\n";
       }
       html += "</div>";
       // list.innerHTML = html;
       // el.appendChild(list);
       el.innerHTML = btn + html;
       console.log("makeSettingsDropdown");
       console.log(el.innerHTML);
       console.dir(el);
       toolbar.appendChild(el);
       $(".showbus_checkbox").on('click', function(e) {
          if (this.checked) {
             
          }
       });
    }

}

var buses, myevent, drivers, mybuses = {}, mydrivers = {};
function init() {
   doCalendar();

   // Fetch vehicle(resources) data and store for later use
   makeRequest('GET', 'api.php?type=resources', function (err, data) {
      buses = JSON.parse(data);
      for (var i=0; i<buses.length; i++){
         mybuses[buses[i].busID] = buses[i];
      }
      makeSettingsDropdown(buses);
      console.log("Buses:");
      console.dir(mybuses);
   });
   
   // Fetch driver data and store for later use
   makeRequest('GET', 'api.php?type=drivers', function (err, data) {
      drivers = JSON.parse(data);
      for (var i=0; i<drivers.length; i++){
         mydrivers[drivers[i].EmployeeID] = drivers[i];
      }
      console.log("Drivers:");
      console.dir(mydrivers);
   });

   makeTabs(".tabs");

}

window.addEventListener("load", init);
</script>
</body>
</html>
