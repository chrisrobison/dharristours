<!DOCTYPE html>
<html lang='en'>
<head>
<title>Reservations &amp; Schedules</title>
<meta charset='utf-8' />
<link href='main.css' rel='stylesheet' />
<link href='/lib/css/tiny-date-picker.css' rel='stylesheet' />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src='/lib/js/tiny-date-picker.min.js'></script>
<script src='mycal.js'></script>
<style>
.dlgtitle {
   font-size:1.5em; 
   background-color:#333;
   color:#eee;
   margin:0;
   padding:.5em;
}
.overlay {
   position:absolute;
   z-index:9999;
   background-color:#00000066;
   top:0px;
   left:0px;
   right:0px;
   bottom:0px;
}
.suggestion:hover {
   background-color:#333;
   color:#eee;
   cursor:pointer;
}
.suggestion a:hover {
   color:#fff;
   font-weight:bold;

}
#dialog {
   position:absolute;
   width:35rem;
   background-color:#ffffff;
   border:1px solid #000;
   box-shadow: 3px 3px 3px #000000cc;
   left:30%;
   top:10rem;
   padding:0px;
}
.dlgform {
   padding:1rem;
}
.form-group {
   position:relative;
}
.suggestions {
   position:absolute;
   left:8em; 
   width:75%;
   height:0rem;
   transition: height 200ms;
   background-color:#fff;
   border:0px solid #3330;
   padding:0px;
   z-index:99999;
   overflow-y:scroll; 
}
.suggestion a {
   padding:.5rem;
   text-decoration:none;
   color:#333; 
}
#dialog label {
   display:inline-block;
   width:8em;
   text-align:right;
}
.form-control {
   width:22rem;
   display:inline-block;
}
.form-time {
   width:5em;
   display:inline-block;
}
.right {
   text-align:right;
}
</style>
</head>
<body>
<div class='left'>
  <div id='tinycal'></div>
  <div id='details' class='tabs'>
      <ul>
        <li><a href="#joblist" class="active joblist">Jobs</a></li> 
        <li><a href="#detail" class='detail'>Details</a></li> 
      </ul>

      <div id='joblist'> </div>
      <div id='detail'> </div>
   </div>
</div>
  <div id='calendar'></div>
<script>
   
   var dp = TinyDatePicker('#tinycal', { 
      format(date) {
         return date.toLocaleDateString();
      },
      parse(str) {
          var date = new Date(str);
          return isNaN(date) ? new Date() : date;
      },
      mode: 'dp-permanent' 
   });

   dp.on('statechange', (_, picker) => { 
      console.log(picker.state.hilightedDate.toISOString()); 
      calendar.gotoDate(picker.state.hilightedDate.toISOString()); 

   } );
   var calendar, calendarEl;

   function doCalendar(exclude) {
      calendarEl = document.getElementById('calendar');

      calendar = new FullCalendar.Calendar(calendarEl, {
      plugins: [ 'interaction', 'resourceDayGrid', 'resourceTimeGrid' ],
      defaultView: 'resourceTimeGridDay',
      defaultDate: new Date().toISOString().substr(0, 10),
      editable: true,
      selectable: true,
      eventLimit: true, // allow "more" link when too many events
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'resourceTimeGridDay,resourceTimeGridTwoDay,timeGridWeek,dayGridMonth'
      },
      views: {
        resourceTimeGridTwoDay: {
          type: 'resourceTimeGrid',
          duration: { days: 2 },
          buttonText: '2 days',
        }
      },
      timeZone: "America/Los_Angeles",
      schedulerLicenseKey: '12345-fcs-67890',
      //// uncomment this line to hide the all-day slot
      allDaySlot: false,

      resources: {
         url: "api.php?type=resources"
      },
      events: {
         url: "api.php?type=events"
      },
      eventSourceSuccess: function(content, xhr) {
        console.log("eventSourceSuccess");
        console.dir(content);
        
        const jobs = document.querySelector("#joblist");
        var html = "<table class='jobs'><thead><tr><th>Job</th><th>Start</th><th>End</th><th>Link</th></tr></thead><tbody>";
        var sel = calendar.getDate(), rowclass='';
        sels = (new Date(calendar.getDate().toISOString().substr(0,10)).getTime()); 
        for (var i in content) { 
           id = (new Date(content[i].start).getTime());
           if ((id > sels) && (id < sels + 86400000)) {
               rowclass = "";
               if (content[i].title.match(/CANCELLED/i)) {
                  content[i].title = content[i].title.replace(/\s*CANCELLED\s*/, '');
                  rowclass = "cancelled";
               } else {
                  rowclass = "";
               }
               html += "<tr><td class='"+rowclass+"'>"+content[i].title+"</td><td class='"+rowclass+"'>"+cleanTime(content[i].start)+"</td><td class='"+rowclass+"'>"+cleanTime(content[i].end)+"</td><td><a target='_blank' href=\""+content[i].url+"\">&#128279;</a></td></tr>";
           }
        }
        html += "</tbody></table>";
        jobs.innerHTML = html;
        selectTab(document.querySelector("a[href='#joblist']")); 
        return content.eventArray;
      },
      select: function(arg) {
         console.dir(arg);
        console.log(
          'select',
          arg.startStr,
          arg.endStr,
          arg.resource ? arg.resource.id : '(no resource)'
        );
        modal(arg.start, arg.end, arg.resource);
      },
      dateClick: function(arg) {
        console.log(
          'dateClick',
          arg.date,
          arg.resource ? arg.resource.id : '(no resource)'
        );
      },
      datesRender: function(arg) {
         dp.setState({"selectedDate": new Date(arg.view.currentStart.getTime())})
         console.log("datesRender");
         console.dir(arg);
      }
    });

    calendar.render();

   }

   function cleanTime(date) {
      var mydate = new Date(date);
      var hr = mydate.getHours();
      var xm = (hr < 12) ? "am" : "pm";
      hr = (hr > 12) ? hr - 12 : hr;
      if (hr == 0) {
         hr = 12;
      }
      var min = mydate.getMinutes();
      min = (min < 10) ? "0" + min : min;

      var mytime = hr+':'+min+xm;

      if (mytime == "12:00am") {
         mytime = "-";
      }
      return mytime;
   }

   function handleClick(who) { 
      
      makeRequest('GET', 'api.php?type=event&id='+who, function (err, datums) {
        myevent = JSON.parse(datums);
        console.dir(myevent);

        var out = "<table id='jobdetail'><tr><th>Job ID</th><td>" + myevent.JobID + "</td>";
        out += "<th>Passengers</th><td>" + ((myevent.NumberOfItems) ? myevent.NumberOfItems : "?") + "</td></tr>";
        out += "<tr><th>Job</th><td colspan='3'>"+myevent.Job+"</td></tr>";
        out += "<tr><th>Bus</th><td colspan='3'>" + mybuses[myevent.BusID].title + "</td></tr>";
        
        var driver = (myevent && myevent.EmployeeID && mydrivers && mydrivers[myevent.EmployeeID]) ? mydrivers[myevent.EmployeeID].Driver + " - " + mydrivers[myevent.EmployeeID].Phone : "Unassigned";
      
        out += "<tr><th>Driver</th><td colspan='3'>" + driver + "</td></tr>";
        out += "<tr><th>Pickup</th><td colspan='2'>"+ ((myevent.PickupLocation) ? myevent.PickupLocation : "") +"</td><td>" +myevent.PickupTime + "</td></tr>";
        out += "<tr><th>Dropoff</th><td colspan='2'>"+ ((myevent.DropOffLocation) ? myevent.DropOffLocation : "") +"</td><td>" +myevent.DropOffTime + "</td></tr>";
        if (myevent.finalDropOffLocation) {
         out += "<tr><th>Final</th><td colspan='2'>"+myevent.FinalDropOffLocation +"</td></tr>";
        }
        out += "</table>";

        document.querySelector("#detail").innerHTML = out;
        selectTab("#detail");
        if (err) { throw err; }
        console.log(datums);
      }); 
   } 
   function makeRequest (method, url, done) {
     var xhr = new XMLHttpRequest();
     xhr.open(method, url);
     xhr.onload = function () {
       done(null, xhr.response);
     };
     xhr.onerror = function () {
       done(xhr.response);
     };
     xhr.send();
   }
   function cleanTabs(selector) {
      var tab_lists_anchors = document.querySelectorAll(selector + " li a");
      var divs = document.querySelector(selector).getElementsByTagName("div");
      
      for (i = 0; i < divs.length; i++) {
          divs[i].style.display = "none";
      }

      for (i = 0; i < tab_lists_anchors.length; i++) {
          tab_lists_anchors[i].classList.remove("active");
      }
 
   }
   function selectTab(who) {
      cleanTabs(".tabs");
      if (typeof who === "string") {
         who = document.querySelector("a[href=\""+who+"\"]");
      }
      who.classList.add('active');
      div_to_show = who.getAttribute('href');
      document.querySelector(div_to_show).style.display = "block";

   }
function makeTabs(selector) {
    tab_lists_anchors = document.querySelectorAll(selector + " li a");
    divs = document.querySelector(selector).getElementsByTagName("div");
    
    for (var i = 0; i < tab_lists_anchors.length; i++) {
        if (tab_lists_anchors[i].classList.contains('active')) {
            divs[i].style.display = "block";
        }
 
    }
 
    for (i = 0; i < tab_lists_anchors.length; i++) {
        document.querySelectorAll(".tabs li a")[i].addEventListener('click', function(e) {
 
            cleanTabs(selector);
 
            clicked_tab = e.target || e.srcElement;
            selectTab(clicked_tab); 
        });
    }
}
function makeSettingsDropdown(resources) {
    var toolbar = document.querySelector(".fc-right .fc-button-group");

    if (toolbar) {
       var el = document.createElement('button');
       el.className = "dropdown fc-button-primary";
       el.style = "margin-left:.25rem;";      
       var btn = "<button id='settingButton' class='fc-button fc-button-primary dropdown-toggle' data-toggle='dropdown'>Buses</button>";
       /*
       var btn = document.createElement('button');
       btn.className = "btn btn-secondary dropdown-toggle";
       btn.type = "button";
       btn.id = "settingsButton";
       btn.dataToggle = "dropdown";
       btn.ariaHasPopup = true;
       btn.ariaExpanded = false;
       btn.innerHTML = '<span class="glyphicon glyphicon-cog" aria-hidden="true"></span>'; 
       el.appendChild(btn);
       */

       var list = document.createElement('div');
//       list.className = "dropdown-menu";
       var html = "<div class='dropdown-menu dropdown-menu-right'>";

       for (var i in resources) {
           html += "<a class='dropdown-item' href='#'><input type='checkbox' class='showbus_checkbox' id='showbus_" + resources[i].id + "' checked='true'> " + resources[i].title + "</a>\n";
       }
       html += "</div>";
       // list.innerHTML = html;
       // el.appendChild(list);
       el.innerHTML = btn + html;
       console.log("makeSettingsDropdown");
       console.log(el.innerHTML);
       console.dir(el);
       toolbar.appendChild(el);
       $(".showbus_checkbox").on('click', function(e) {
          if (this.checked) {
             
          }
       });
    }

}

var buses, myevent, drivers, mybuses = {}, mydrivers = {};
function init() {
   doCalendar();

   // Fetch vehicle(resources) data and store for later use
   makeRequest('GET', 'api.php?type=resources', function (err, data) {
      buses = JSON.parse(data);
      for (var i=0; i<buses.length; i++){
         mybuses[buses[i].busID] = buses[i];
      }
      makeSettingsDropdown(buses);
      console.log("Buses:");
      console.dir(mybuses);
   });
   
   // Fetch driver data and store for later use
   makeRequest('GET', 'api.php?type=drivers', function (err, data) {
      drivers = JSON.parse(data);
      for (var i=0; i<drivers.length; i++){
         mydrivers[drivers[i].EmployeeID] = drivers[i];
      }
      console.log("Drivers:");
      console.dir(mydrivers);
   });

   makeTabs(".tabs");

}
function formatTime(d) {

   var hr = parseInt(d.toISOString().substr(11,2));
   var xm = 'am';
   if (hr>=12) {
      hr -= 12;
      xm = 'pm';
   }
   var min = d.toISOString().substr(14,2);

   return hr + ':' + min + xm;
}

function closeDialog() {
   var over = document.querySelector("#overlay");
   over.parentElement.removeChild(over);
}

function makeReservation(event, cust, pu, dr, fr, to, pax) {
   event.preventDefault();
   event.stopPropagation();

   const out = { "customer": cust, "date": window.reservation.date, "pickup": pu, "dropoff": dr, "from": window.reservation.from, "to": window.reservation.to, "pax": pax };
   fetch("api.php?type=reserve&data=" + encodeURIComponent(JSON.stringify(out))).then((response) => { return response.json(); }).then((data) => {
      console.log("from fetch in makeReservation");
      console.dir(data);
   });
}

function modal(from, to, rsc) {
   var overlay = document.createElement('div');
   overlay.id = 'overlay';
   overlay.className = 'overlay';
   
   window.reservation = { "date": from.toLocaleDateString(), "from": from, "to": to };

   var oform = "<form id='newdlg' action='api.php' onsubmit='return makeReservation()' autocomplete='off'>";
   oform += "<input type='hidden' name='type' value='form'/>";
   oform += "<div id='dialog'>";
   oform += "<div class='dlgtitle'>Reserve Bus " + rsc._resource.id + " on " + from.toLocaleDateString() + "</div>";
   oform += "<div class='dlgform'>";
   oform += "<div class='form-group'><label for='customer'>Customer</label> <input type='text' id='customer' name='customer' placeholder='Customer' class='form-control' onchange='handleForm(this)' autocomplete='off' /><div id='customer_suggestions' class='suggestions'></div></div>";
   oform += "<div class='form-group'><label for='from'>From</label> <input type='text' id='from' name='from' placeholder='Pickup Time' value='" + formatTime(from) + "' size='10' class='form-time' onchange='handleForm(this)'/>";
   oform += "<label style='width:2em' for='to'>To</label> <input type='text' id='to' name='to' placeholder='Dropoff Time' value='" + formatTime(to) + "' size='10' class='form-time' onchange='handleForm(this)'/>";
   oform += "<label style='width:3em' for='pax'>Pax</label> <input type='text' id='pax' name='pax' placeholder='<=" + rsc._resource.id.substr(0,2) + "' size='10' class='form-time' onchange='handleForm(this)' autocomplete='off' /></div>";
   oform += "<div class='form-group'><label for='pickup'>Pickup</label> <input type='text' id='pickup' name='pickup' placeholder='Pickup Location' class='form-control' onchange='handleForm(this)' autocomplete='off' /><div id='pickup_suggestions' class='suggestions'></div></div>";
   oform += "<div class='form-group'><label for='dropoff'>Dropoff</label> <input type='text' id='dropoff' name='dropoff' placeholder='Dropoff Location' class='form-control' onchange='handleForm(this)' autocomplete='off' /><div id='dropoff_suggestions' class='suggestions'></div></div>";
   oform += "<div class='form-group right'><button id='dlg_cancel' onclick='closeDialog()'>Cancel</button> <button id='dlg_reserve' onclick='makeReservation()'>Reserve</button></div>";
   oform += "</div>";
   oform += "</div>";
   oform += "</form>";

   overlay.innerHTML = oform;
   document.body.append(overlay); 
   
   const customer = document.querySelector('#customer');
   const pickup = document.querySelector('#pickup');
   const dropoff = document.querySelector('#dropoff');
   const frel = document.querySelector('#from');
   const toel = document.querySelector('#to');
   const pax = document.querySelector('#pax');
   const dlgform = document.querySelector('#newdlg');
    
   customer.addEventListener("keydown", event => { doSuggestions('customer', event); });
   pickup.addEventListener("keydown", event => { doSuggestions('pickup', event); });
   dropoff.addEventListener("keydown", event => { doSuggestions('dropoff', event); });
   dlgform.addEventListener("submit", event => { makeReservation(event, customer.value, pickup.value, dropoff.value, frel.value, toel.value, pax.value); });
   customer.focus();
}

function handleForm(obj) {
   console.log("handleForm");
   console.dir(obj);
}

function pickSuggestion(txt, who) {
   txt = txt.replace(/<[^>]*>/g, '');
   var el = document.querySelector('#' + who);
   el.value = txt;
   const dropdown = document.querySelector("#" + who + "_suggestions");
   dropdown.style.height = "0px";
   dropdown.style.border = '0px';
   return false;
}
window.dialogState = {};

function doSuggestions(who, evt) {
   console.dir(evt);
   var txt = document.querySelector("#"+who).value;
   if (evt.key.length===1) {
      txt += evt.key;
   }
   
   // Handle 'ESC' key
   if (evt.keyCode === 27) {
      if (window.dialogState.open) {
         window.dialogState.nosuggestions = true;
         const dd = document.querySelector("#" + who + "_suggestions");
         if (dd) {
            dd.style.height = "0px";
            dd.style.border = "0px";
         }
      }
   }

   if ((evt.key == "Tab") || (evt.keyCode === 13)) {
      if (window.suggestions.length) {
         pickSuggestion(window.suggestions[0], who);
      }

      if (who == 'customer') {
         document.querySelector('#pickup').focus();
      } else if (who == 'pickup') {
         document.querySelector('#dropoff').focus();
      } else if (who == 'dropoff') {
         document.querySelector('#dlg_cancel').focus();
      }
      window.suggestions = [];
      window.dialogState.nosuggestions = false;
      evt.preventDefault();
      evt.stopPropagation();
      return false;
   }

   if (evt.key == "Backspace") {
      txt = txt.substr(0, txt.length - 1);
   }
   if (!txt.match(/\w/)) {
      var el = document.querySelector("#" + who + "_suggestions");
      el.innerHTML = '';
      el.style.height = "0px";
      el.style.border = "0px solid #3330";
      return true;
   }
   if (!window.dialogState.nosuggestions) {
      fetch("api.php?type=suggestion&rsc=" + who + "&q=" + txt).then((response) => { return response.json(); }).then((data) => {
         var out = '';
         window.suggestions = data['results'];

         for (var i in data['results']) {
            var item = data['results'][i];
            out += "<div class='suggestion'><a href='#' onclick='return pickSuggestion(\"" + item + "\", \""+who+"\")'>" + item + "</a></div>";
         }
         var el = document.querySelector("#" + who + "_suggestions");
         el.innerHTML = out;
         el.style.height = "9rem";
         el.style.border = "1px solid #333";
         window.dialogState.open = who;
      });
   }
}
window.addEventListener("load", init);
</script>
</body>
</html>
