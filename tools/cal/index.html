<!DOCTYPE html>
<html lang='en'>
<head>
<title>Reservations &amp; Schedules</title>
<meta charset='utf-8' />
<link href='main.css' rel='stylesheet' />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href='/lib/css/tiny-date-picker.css' rel='stylesheet' />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/fontawesome.min.css" integrity="sha384-wESLQ85D6gbsF459vf1CiZ2+rr+CsxRY0RpiF1tLlQpDnAgg6rwdsUF1+Ics2bni" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
<link rel="stylesheet" href="/lib/css/bus-loader.css"/>

<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>

<script src='/lib/js/tiny-date-picker.min.js'></script>
<script src='mycal.js'></script>
<style>
* { box-sizing: border-box; }
body {
   font-family: 'Lexend', sans-serif;
   box-sizing: border-box;
}
.dlgtitle {
   font-size:1.5em; 
   background-color:#333;
   color:#eee;
   margin:0;
   padding:.5em;
}
.overlay {
   position:absolute;
   z-index:9999;
   background-color:#00000066;
   top:0px;
   left:0px;
   right:0px;
   bottom:0px;
}
.suggestion:hover {
   background-color:#333;
   color:#eee;
   cursor:pointer;
}
.suggestion a:hover {
   color:#fff;
   font-weight:bold;

}
#dialog {
   position:absolute;
   width:35rem;
   background-color:#ffffff;
   border:1px solid #000;
   box-shadow: 3px 3px 3px #000000cc;
   left:30%;
   top:10rem;
   padding:0px;
}
.dlgform {
   padding:1rem;
}
#dialog .form-group {
   position:relative;
   margin-bottom: 2vh;
}
.suggestions {
   position:absolute;
   left:8em; 
   width:75%;
   height:0rem;
   transition: height 200ms;
   background-color:#fff;
   border:0px solid #3330;
   padding:0px;
   z-index:99999;
   overflow-y:scroll; 
}
.suggestion a {
   padding:.5rem;
   text-decoration:none;
   color:#333; 
}
#dialog label {
   display:inline-block;
   width:8em;
   text-align:right;
}
.form-control {
   width:22rem;
   display:inline-block;
}
.form-time {
   width:5em;
   display:inline-block;
}
.right {
   text-align:right;
}
div.dropdown-open {
   display:block;
   right: 0px;
}
div.dropdown-menu {
   box-shadow: 3px 3px 3px #0009;
   transition: all 200ms linear;
}
.dp-cal-footer {
display:none;
}
.left {
   justify-content: flex-start;
}
#map {
   height: 33vh;
   border: 1px solid #0009;
}
#details {
   margin: 0px;
   min-height: 37vh;
}
thead {
   z-index:99999;
   position: relative;
   filter: drop-shadow(0px 2px 3px #0003);
}
.lds-spinner {
  color: official;
  display: inline-block;
  position: relative;
  width: 80px;
  height: 80px;
}
.lds-spinner div {
  transform-origin: 40px 40px;
  animation: lds-spinner 1.2s linear infinite;
}
.lds-spinner div:after {
  content: " ";
  display: block;
  position: absolute;
  top: 3px;
  left: 37px;
  width: 6px;
  height: 18px;
  border-radius: 20%;
  background: #fff;
}
.lds-spinner div:nth-child(1) {
  transform: rotate(0deg);
  animation-delay: -1.1s;
}
.lds-spinner div:nth-child(2) {
  transform: rotate(30deg);
  animation-delay: -1s;
}
.lds-spinner div:nth-child(3) {
  transform: rotate(60deg);
  animation-delay: -0.9s;
}
.lds-spinner div:nth-child(4) {
  transform: rotate(90deg);
  animation-delay: -0.8s;
}
.lds-spinner div:nth-child(5) {
  transform: rotate(120deg);
  animation-delay: -0.7s;
}
.lds-spinner div:nth-child(6) {
  transform: rotate(150deg);
  animation-delay: -0.6s;
}
.lds-spinner div:nth-child(7) {
  transform: rotate(180deg);
  animation-delay: -0.5s;
}
.lds-spinner div:nth-child(8) {
  transform: rotate(210deg);
  animation-delay: -0.4s;
}
.lds-spinner div:nth-child(9) {
  transform: rotate(240deg);
  animation-delay: -0.3s;
}
.lds-spinner div:nth-child(10) {
  transform: rotate(270deg);
  animation-delay: -0.2s;
}
.lds-spinner div:nth-child(11) {
  transform: rotate(300deg);
  animation-delay: -0.1s;
}
.lds-spinner div:nth-child(12) {
  transform: rotate(330deg);
  animation-delay: 0s;
}
@keyframes lds-spinner {
  0% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}
#loading {
   position:absolute;
   bottom:0px;
   height: 33vh;
   background: #0009;
   left: 0px;
   width: 100%;
   z-index: 99999;
   display: flex;
   align-items: center;
   justify-content: center;
   display: none;
}
#mapWrap {
   position: relative;
   height:33vh;
}
#sadmac {
   position: absolute; 
   top: 0px;
   left: 0px;
   display: flex;
   flex-direction: column;
   align-items: center;
   justify-content: center;
   z-index: 99999;

   height: 33vh;
   width: 100%;
}
#sadmac img {
   height: 18vh;
}
#sizer {
  display: inline-block;
  width: 8px;
  height: 100vh;
  cursor: ew-resize;
  background-color:#ccc;
}
</style>
</head>
<body>
<div class='left'>
  <div id='tinycal'></div>
  <div id='details' class='tabs'>
      <ul>
        <li><a href="#joblist" class="active joblist">Jobs</a></li> 
        <li><a href="#detail" class='detail'>Details</a></li> 
      </ul>

      <div id='joblist' class='tabpane'> </div>
      <div id='detail' class='tabpane'> </div>
   </div>
   <div id="mapWrap">
      <div id='map'></div>
      <div id='loading'><div class="loader"></div></div>
      <div id='sadmac'><img src="/img/where.svg"></div>
   </div>
</div>
<div class="sizer"></div>
<div id='calendar'></div>
<script src="route.js"></script>
<script>
(function() {
 app.map = L.map('map', {
     attributionControl: false,
   zoomControl: false,
   fadeAnimation: false,
   zoomAnimation: false
 }).setView([37.8437122,-122.3491274], 10);
 L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
     maxZoom: 19,
     attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
 }).addTo(app.map);
})();
 </script>
<script>
   var dp = TinyDatePicker('#tinycal', { 
      format(date) {
         return date.toLocaleDateString();
      },
      parse(str) {
          var date = new Date(str);
          return isNaN(date) ? new Date() : date;
      },
      mode: 'dp-permanent' 
   });

   dp.on('select', (_, dp) => {
         console.log("SELECTED", dp.state.selectedDate);
         calendar.gotoDate(dp.state.selectedDate);
      }
   );

   dp.on('statechange', (_, picker) => { 
      console.log("statechange");
   } );
   var calendar, calendarEl;
   fetch("api.php?type=drivers").then(resp=>resp.json()).then(data=>{
      drivers = data;
   });

   function doCalendar(exclude) {
      calendarEl = document.getElementById('calendar');
      
      calendar = new FullCalendar.Calendar(calendarEl, {
         plugins: [ 'interaction', 'resourceDayGrid', 'resourceTimeGrid' ],
         defaultView: 'resourceTimeGridDay',
         defaultDate: new Date(),
         editable: false,
         selectable: true,
         droppable: false,
         eventLimit: true, // allow "more" link when too many events
         eventResourceEditable: true,
         eventDurationEditable: false,
         header: {
           left: 'prev,next today',
           center: 'title',
           right: 'resourceTimeGridDay,resourceDayGridDay,dayGridMonth'
         },
         views: {
            resourceDayGridDay: {
               buttonText: 'list'
            },
           resourceTimeGridTwoDay: {
             type: 'resourceTimeGrid',
             duration: { days: 2 },
             buttonText: '2 days',
           }
         },
         timeZone: "local",
         schedulerLicenseKey: '12345-fcs-67890',
         //// uncomment this line to hide the all-day slot
         allDaySlot: false,

         resources: {
            url: "api.php?type=resources"
         },
         events: {
            url: "api.php?type=events"
         },
         eventDrop: function(info) {
            console.log(">>>Event drop");
            console.dir(info);
            
            let upd = [];

            if (info.newResource && info.newResource.id) {
                upd["newResource"] = info.newResource.id;
            } 
            /*
            if (info.oldEvent) {
               let chkStart = cleanMilitaryTime(info.event.start);
               let chkOldStart = cleanMilitaryTime(info.oldEvent.start);

               if (chkStart != chkOldStart) {
                  let newStart = cleanTime(info.event.start);
                  let oldStart = cleanTime(info.oldEvent.start);
                  
                  upd["newStart"] = cleanMilitaryTime(info.event.start);
               }

               let chkEnd = cleanMilitaryTime(info.event.end);
               let chkOldEnd = cleanMilitaryTime(info.oldEvent.end);

               if (chkEnd != chkOldEnd) {
                  let newEnd = cleanTime(info.event.end);
                  let oldEnd = cleanTime(info.oldEvent.end);
               
                  upd["newEnd"] = cleanMilitaryTime(info.event.end);
               }
            }
            */
            
            if (Object.keys(upd).length) {
               console.log(`New data:`);
               console.dir(upd);
               let confirmation = `Update Job[${info.event.id}] with:\n`;
               let items = Object.keys(upd);
               items.forEach(idx=>{
                  confirmation += `            ${idx}: ${upd[idx]}\n`;
               });

               if (!confirm(confirmation)) {
                  info.revert();
               } else {
                  updateData(upd, info.event.id);
               }
            }
   
         },

         eventSourceSuccess: function(content, xhr) {
           console.log("eventSourceSuccess");
           console.dir(content);
           
           const jobs = document.querySelector("#joblist");
           let html = `<table class='jobs'><thead><tr><th>Job</th><th>Start</th><th>End</th><th>Link</th></tr></thead><tbody>`;
           let sel = calendar.getDate(), rowclass='';
           sels = (new Date(calendar.getDate().toISOString().substr(0,10)).getTime()); 
           let duration = (calendar.view.type == "dayGridMonth") ? sels + (31 * 86400000) : sels + 86400000;
           for (let i in content) { 
              id = (new Date(content[i].start).getTime());
              if ((id > sels) && (id < duration)) {
                  rowclass = "";
                  if (content[i].title.match(/CANCELLED/i)) {
                     content[i].title = content[i].title.replace(/\s*CANCELLED\s*/, '');
                     rowclass = "cancelled";
                  } else {
                     rowclass = "";
                  }
                  html += "<tr><td class='"+rowclass+"'>"+content[i].title+"</td><td class='"+rowclass+"'>"+cleanTime(content[i].start)+"</td><td class='"+rowclass+"'>"+cleanTime(content[i].end)+"</td><td><a target='_blank' href=\""+content[i].url+"\">&#128279;</a></td></tr>";
              }
           }
           html += "</tbody></table>";
           jobs.innerHTML = html;
           // selectTab(document.querySelector("a[href='#joblist']")); 
           return content.eventArray;
         },
         select: function(arg) {
           console.log(
             'select',
             arg.startStr,
             arg.endStr,
             arg.resource ? arg.resource.id : '(no resource)'
           );
           modal(arg.start, arg.end, arg.resource);
         },
         dateClick: function(arg) {
           console.log(
             'dateClick',
             arg.date,
             arg.resource ? arg.resource.id : '(no resource)'
           );
         },
         datesRender: function(arg) {
            dp.setState({"selectedDate": new Date(arg.view.currentStart.getTime())})
            console.log("datesRender");
            console.dir(arg);
         }
    });

    calendar.render();

   }
   
   function cleanMilitaryTime(date) {
      let mydate = new Date(date);
      let hr = mydate.getHours();
      hr = (hr < 10) ? "0" + hr : hr;

      let min = mydate.getMinutes();
      min = (min < 10) ? "0" + min : min;
      
      console.log(`cleanMilitaryTime: ${hr}:${min}:00`);
      return `${hr}:${min}:00`;
   }

   function cleanTime(date) {
      var mydate = new Date(date);
      var hr = mydate.getHours();
      var xm = (hr < 12) ? "am" : "pm";
      hr = (hr > 12) ? hr - 12 : hr;
      if (hr == 0) {
         hr = 12;
      }
      var min = mydate.getMinutes();
      min = (min < 10) ? "0" + min : min;

      var mytime = hr+':'+min+xm;

      if (mytime == "12:00am") {
         mytime = "-";
      }
      return mytime;
   }
   function updateDriver(id) {

   }
   function makeDriverSelect(id) {
      let out = "<select id='Driver' name='Driver' onchange='updateDriver(this.options[this.selectedIndex].value)'><option value='0'>Unassigned</option>";
      if (mydrivers) {
         let keys = Object.keys(mydrivers), sel = "", phone = "";
         keys.forEach(key=> {
            sel = (mydrivers[key].EmployeeID == id) ? " SELECTED" : "";
            phone = (mydrivers[key].Phone) ? ` - ${mydrivers[key].Phone}` : "";
               
            out += `<option value='${mydrivers[key].EmployeeID}'${sel}>${mydrivers[key].Driver}${phone}</option>`;
         });

      }
      out += "</select>";
      
      return out;
   }

   function handleClick(who) { 
      
      makeRequest('GET', 'api.php?type=event&id='+who, function (err, datums) {
        myevent = JSON.parse(datums);
        console.dir(myevent);

        var out = `<table id='jobdetail'>
         <tr>
            <th>Job ID</th><td>${myevent.JobID}</td>
            <th>Passengers</th><td>${((myevent.NumberOfItems) ? myevent.NumberOfItems : "?")}</td>
         </tr>
         <tr><th>Job</th><td colspan='3'>${myevent.Job}</td></tr>
         <tr><th>Bus</th><td colspan='3'>${mybuses[myevent.BusID].title}</td></tr>`;
        
        var driver = (myevent && myevent.EmployeeID && mydrivers && mydrivers[myevent.EmployeeID]) ? mydrivers[myevent.EmployeeID].Driver + " - " + mydrivers[myevent.EmployeeID].Phone : "Unassigned";
      
        out += `
         <tr><th>Driver</th><td colspan='3'>${makeDriverSelect(myevent.EmployeeID)}</td></tr>
         <tr><th>Pickup</th><td colspan='2'>${((myevent.PickupLocation) ? myevent.PickupLocation : "")}</td><td>${myevent.PickupTime}</td></tr>
         <tr><th>Dropoff</th><td colspan='2'>${((myevent.DropOffLocation) ? myevent.DropOffLocation : "")}</td><td>${myevent.DropOffTime}</td></tr>`;
        
        if (myevent.finalDropOffLocation) {
         out += `<tr><th>Final</th><td colspan='2'>${myevent.FinalDropOffLocation}</td></tr>`;
        }

        out += `<tr><th>Color</th><td colspan='3'><input type='color' value='${myevent.Color}' id='color' onchange='updateColor(this.value, ${myevent.JobID})'> <div style="display:inline-block;float:right;"><span id="distance"></span> | <span id="duration"></span></div></td></tr>`;
        out += `</table>`;

        document.querySelector("#detail").innerHTML = out;
        selectTab("#detail");

        app.getRoute(myevent.PickupLocation, myevent.DropOffLocation);

        if (err) { throw err; }
        console.log(datums);
      }); 
   }

   function updateData(items, id) {
      console.log(`update: ${id} ${items}`);
      if (items && id) {
         let url = `api.php?id=${id}&`;
         let keys = Object.keys(items);

         keys.forEach((key) => {
            url += key + '=' + items[key] + '&';
         });
         url += 'type=update';
         console.log(url);
         fetch(url).then(resp=>resp.json()).then(data=>{
            console.dir(data);
            calendar.refetchEvents();
         });
      }
   }

   function updateColor(newcolor, id) {
      console.log(`updateColor: ${newcolor} [${id}] `);
      if (color && id) {
         let url = `api.php?id=${id}&type=updateColor&color=${encodeURIComponent(newcolor)}`;
         console.log(url);
         fetch(url).then(response=>response.json()).then(data=>{
            console.dir(data);
            calendar.refetchEvents();
         });
      }
   }

   function makeRequest (method, url, done) {
     var xhr = new XMLHttpRequest();
     xhr.open(method, url);
     xhr.onload = function () {
       done(null, xhr.response);
     };
     xhr.onerror = function () {
       done(xhr.response);
     };
     xhr.send();
   }
   function cleanTabs(selector) {
      var tab_lists_anchors = document.querySelectorAll(selector + " li a");
      var divs = document.querySelectorAll(".tabpane");
      divs.forEach((el) => {
         el.style.display = "none";
      });

      for (i = 0; i < tab_lists_anchors.length; i++) {
          tab_lists_anchors[i].classList.remove("active");
      }
 
   }
   function selectTab(who) {
      if (who) {
         cleanTabs(".tabs");
         if (typeof who === "string") {
            who = document.querySelector(`a[href="${who}"]`);
         }
         who.classList.add('active');
         div_to_show = who.getAttribute('href');
         document.querySelector(div_to_show).style.display = "block";
      }
   }
function makeTabs(selector) {
    tab_lists_anchors = document.querySelectorAll(selector + " li a");
    divs = document.querySelector(selector).getElementsByTagName("div");
    
    for (var i = 0; i < tab_lists_anchors.length; i++) {
        if (tab_lists_anchors[i].classList.contains('active')) {
            divs[i].style.display = "block";
        }
 
    }
 
    for (i = 0; i < tab_lists_anchors.length; i++) {
        document.querySelectorAll(".tabs li a")[i].addEventListener('click', function(e) {
 
            cleanTabs(selector);
 
            clicked_tab = e.target || e.srcElement;
            selectTab(clicked_tab); 
        });
    }
}
function makeSettingsDropdown(resources) {
    var toolbar = document.querySelector(".fc-right .fc-button-group");

    if (toolbar) {
       var el = document.createElement('button');
       el.className = "dropdown fc-button-primary";
       el.style = "margin-left:.25rem;";      
       var btn = "<button id='settingButton' class='fc-button fc-button-primary dropdown-toggle' data-toggle='dropdown'>Buses</button>";
       /*
       var btn = document.createElement('button');
       btn.className = "btn btn-secondary dropdown-toggle";
       btn.type = "button";
       btn.id = "settingsButton";
       btn.dataToggle = "dropdown";
       btn.ariaHasPopup = true;
       btn.ariaExpanded = false;
       btn.innerHTML = '<span class="glyphicon glyphicon-cog" aria-hidden="true"></span>'; 
       el.appendChild(btn);
       */

       var list = document.createElement('div');
//       list.className = "dropdown-menu";
       var html = "<div class='dropdown-menu dropdown-menu-right'>";

       let keys = Object.keys(resources);
       for (var i=0; i<keys.length; i++) {
           let rsc = resources[keys[i]];
           let chk = (showbuses[i]) ? " checked='true'" : "";
           html += `<a class='dropdown-item' href='#'><input type='checkbox' class='showbus_checkbox' id='showbus_${rsc.id}' onclick='toggleResource(${i})'${chk}> ${rsc.title}</a>\n`;
       }
       html += "</div>";
       // list.innerHTML = html;
       // el.appendChild(list);
       el.innerHTML = btn + html;
       console.log("makeSettingsDropdown");
       console.log(el.innerHTML);
       console.dir(el);
       toolbar.appendChild(el);
       document.querySelector("#settingButton")?.addEventListener('click', function(e) {
         console.log("settingButton", e);
         document.querySelector(".dropdown-menu").classList.toggle('dropdown-open');
       });
       document.querySelector(".showbus_checkbox")?.addEventListener('click', function(e) {
          if (this.checked) {
             
          }
       });
    }

}
function updateResources() {
   let keys = Object.keys(showbuses);
   keys.forEach(idx=>{
      let key = parseInt(idx);
      let item = showbuses[key];
      if (item) {
         console.log(`Showing bus ${key} : ${item}`);
         document.querySelector(`#calendar > div.fc-view-container > div > table > tbody > tr > td > div > div > div.fc-content-skeleton > table > tbody > tr > td:nth-child(${key+2})`).style.display = "table-cell";
         document.querySelector(`#calendar > div.fc-view-container > div > table > thead > tr > td > div > table > thead > tr > th:nth-child(${key+2})`).style.display = "table-cell";
      } else {
         console.log(`Hiding bus ${key} : ${item}`);
         document.querySelector(`#calendar > div.fc-view-container > div > table > tbody > tr > td > div > div > div.fc-content-skeleton > table > tbody > tr > td:nth-child(${key+2})`).style.display = "none";
         document.querySelector(`#calendar > div.fc-view-container > div > table > thead > tr > td > div > table > thead > tr > th:nth-child(${key+2})`).style.display = "none";

      }
   });
}

function save(key, obj) {
   localStorage.setItem(key, JSON.stringify(obj));
}

function load(key) {
   return JSON.parse(localStorage.getItem(key));
}

function toggleResource(idx) {
   showbuses[idx] ^= 1;
   save("showbuses", showbuses);
   updateResources();
}

function loadSettings() {
   if (localStorage.getItem("showbuses")) {
      let savedbuses = load("showbuses");
      
      showbuses = savedbuses;
   }
   updateResources();
}

var buses, myevent, drivers, mybuses = {}, mydrivers = {}, showbuses = {}, showdrivers = {};
function init() {
   doCalendar();

   // Fetch vehicle(resources) data and store for later use
   makeRequest('GET', 'api.php?type=resources', function (err, data) {
      buses = JSON.parse(data);
      for (var i=0; i<buses.length; i++){
         mybuses[buses[i].busID] = buses[i];
         showbuses[i] = 1; //buses[i].busID;
      }

      loadSettings();
      makeSettingsDropdown(buses);
      console.log("Buses:");
      console.dir(mybuses);
   });
   
   // Fetch driver data and store for later use
   makeRequest('GET', 'api.php?type=drivers', function (err, data) {
      drivers = JSON.parse(data);
      for (var i=0; i<drivers.length; i++){
         mydrivers[drivers[i].EmployeeID] = drivers[i];
      }
      console.log("Drivers:");
      console.dir(mydrivers);
   });

   makeTabs(".tabs");

}
function fullFormatTime(d) {
  var hr = d.getHours();
  if (hr < 10) {
    hr = `0${hr}`;
  }

  var min = d.getMinutes();
  if (min < 10) {
    min = `0${min}`;
  }

  return hr + ':' + min;
}

function formatTime(d) {

   var hr = parseInt(d.toISOString().substr(11,2));
   var xm = 'am';
   if (hr>=12) {
      hr -= 12;
      xm = 'pm';
   }
   var min = d.toISOString().substr(14,2);

   return hr + ':' + min + xm;
}

function closeDialog() {
   var over = document.querySelector("#overlay");
   over.parentElement.removeChild(over);
}

function makeReservation() {
   const customer = document.querySelector('#customer').value;
   const pickup = document.querySelector('#pickup').value;
   const dropoff = document.querySelector('#dropoff').value;
   const frel = document.querySelector('#from').value;
   const toel = document.querySelector('#to').value;
   const pax = document.querySelector('#pax').value;

   const out = { "customer": customer, "date": window.reservation.date, "pickup": pickup, "dropoff": dropoff, "from": window.reservation.from, "to": window.reservation.to, "pax": pax };
   fetch("api.php?type=reserve&data=" + encodeURIComponent(JSON.stringify(out))).then((response) => { return response.json(); }).then((data) => {
      console.log("from fetch in makeReservation");
      console.dir(data);
      closeDialog();
      
      var alert = document.createElement('div');
      alert.className = "alert alert-warning alert-dismissible fade show toast";
      alert.role = 'alert';

      var html = "<b>Success!</b> Your reservation has been made.";
      html += '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>';

      alert.innerHTML = html;
      document.body.append(alert);
      //alert.toast('show');
      alert.alert();


   });
   return false;
}


function modal(from, to, rsc) {
   var overlay = document.createElement('div');
   overlay.id = 'overlay';
   overlay.className = 'overlay';
   var fromString = fullFormatTime(from);

   var toString = fullFormatTime(to);

   console.log(`model: from=${fromString} to=${toString}`);
   window.reservation = { "date": from.toLocaleDateString(), "from": from, "to": to };

   var oform = `<div id='dialog'>
   <form id='newdlg'>
   <div class='dlgtitle'>Reserve Bus ${rsc._resource.id} on ${from.toLocaleDateString()}</div>
   <div class='dlgform'>
      <div class='form-group'><label for='customer'>Customer</label> <input type='text' id='customer' name='customer' placeholder='Customer' class='form-control' onchange='handleForm(this)' autocomplete='off' /><div id='customer_suggestions' class='suggestions'></div></div>
      <div class='form-group'>
         <label for='from'>Start Time</label> <input type='time' id='from' name='from' placeholder='Pickup Time' value='${fullFormatTime(from)}' size='10' class='form-time' onchange='handleForm(this)'/>
         <label style='width:2em' for='to'>End Time</label> <input type='time' id='to' name='to' placeholder='Dropoff Time' value='${fullFormatTime(to)}' size='10' class='form-time' onchange='handleForm(this)'/>
      </div>
      <div class='form-group'>
         <label for='triptype'>Trip Type</label>
         <select name='triptype' id='triptype' onchange='handleForm(this);if (this.selectedIndex==0) { document.querySelector("#dropoffWrap").style.display="inline-block"; } else { document.querySelector("#dropoffWrap").style.display="none"; }'>
            <option value='roundtrip'>Round Trip</option>
            <option value='oneway'>One Way</option>
         </select>
         <!--input class='form-check-input' type='radio' id='oneway' name='triptype' onchange='handleForm(this)' />
         <input class='form-check-input' type='radio' id='roundtrip' name='triptype' onchange='handleForm(this)' checked=true /><label class='form-check-label' for='roundtrip'>Round Trip</label-->
         <label style='width:3em' for='pax'>Pax</label> <input type='number' id='pax' name='pax' placeholder='<=${rsc._resource.id.substr(0,2)}' size='10' class='form-time' onchange='handleForm(this)' autocomplete='off' />
      </div>
      <div class='form-group'><label for='pickup'>Pickup</label> <input type='text' id='pickup' name='pickup' placeholder='Pickup Location' class='form-control' onchange='handleForm(this)' autocomplete='off' /><div id='pickup_suggestions' class='suggestions'></div></div>
      <div id='dropoffWrap' class='form-group'><label for='dropoff'>Dropoff</label> <input type='text' id='dropoff' name='dropoff' placeholder='Dropoff Location' class='form-control' onchange='handleForm(this)' autocomplete='off' /><div id='dropoff_suggestions' class='suggestions'></div></div>
      <div class='form-group right'><button type='button' id='dlg_cancel' onclick='closeDialog()'>Cancel</button> <button type='button' id='dlg_reserve' onclick='return makeReservation()'>Reserve</button></div>
   </div>
   </form>
</div>`;

   overlay.innerHTML = oform;
   document.body.append(overlay); 
   
   const customer = document.querySelector('#customer');
   const pickup = document.querySelector('#pickup');
   const dropoff = document.querySelector('#dropoff');
   const frel = document.querySelector('#from');
   const toel = document.querySelector('#to');
   const pax = document.querySelector('#pax');
   const dlgform = document.querySelector('#newdlg');
    
   customer.addEventListener("keydown", event => { doSuggestions('customer', event); });
   pickup.addEventListener("keydown", event => { doSuggestions('pickup', event); });
   dropoff.addEventListener("keydown", event => { doSuggestions('dropoff', event); });
   dlgform.addEventListener("submit", event => { makeReservation(event, customer.value, pickup.value, dropoff.value, frel.value, toel.value, pax.value); });
   customer.focus();
}

function handleForm(obj) {
   console.log("handleForm");
   console.dir(obj);
}

function pickSuggestion(txt, who) {
   txt = txt.replace(/<[^>]*>/g, '');
   var el = document.querySelector('#' + who);
   el.value = txt;
   const dropdown = document.querySelector("#" + who + "_suggestions");
   dropdown.style.height = "0px";
   dropdown.style.border = '0px';
   return false;
}
window.dialogState = {
   suggestions: {
      customer: true,
      pickup: true,
      dropoff: true
   }
};

function doSuggestions(who, evt) {
   console.dir(evt);
   var txt = document.querySelector("#"+who).value;
   if (evt.key.length===1) {
      txt += evt.key;
   }
   
   if (evt.key == "Backspace") {
      return true;
   }
   
   // Handle 'ESC' key
   if (evt.keyCode === 27) {
      if (window.dialogState.open) {
         window.dialogState.suggestions[who] = false;
         const dd = document.querySelector("#" + who + "_suggestions");
         if (dd) {
            dd.style.height = "0px";
            dd.style.border = "0px";
            dd.style.display = "none";
         }
      }
   }

   if ((evt.key == "Tab") || (evt.keyCode === 13)) {
      if (window.suggestions.length) {
         pickSuggestion(window.suggestions[0], who);
      }

      if (who == 'customer') {
         document.querySelector('#pickup').focus();
      } else if (who == 'pickup') {
         document.querySelector('#dropoff').focus();
      } else if (who == 'dropoff') {
         document.querySelector('#dlg_cancel').focus();
      }
      window.suggestions = [];
      window.dialogState.nosuggestions = false;
      evt.preventDefault();
      evt.stopPropagation();
      return false;
   }

   if (!txt.match(/\w/)) {
      var el = document.querySelector("#" + who + "_suggestions");
      el.innerHTML = '';
      el.style.height = "0px";
      el.style.border = "0px solid #3330";
      return true;
   }
   if (window.dialogState.suggestions[who]) {
      fetch("api.php?type=suggestion&rsc=" + who + "&q=" + txt).then((response) => { return response.json(); }).then((data) => {
         var out = '';
         window.suggestions = data['results'];
         if (data['results'].length) {
            for (var i in data['results']) {
               var item = data['results'][i];
               out += `<div class='suggestion'><a href='#' onmouseover='this.parentNode.classList.add("hilite")' onmouseout='this.parentNode.classList.remove("hilite")' onclick='return pickSuggestion("${item}", "${who}")'>${item}</a></div>`;
            }
            var el = document.querySelector("#" + who + "_suggestions");
            el.innerHTML = out;
            el.style.height = "9rem";
            el.style.border = "1px solid #333";
            window.dialogState.open = who;
         } else {
            var el = document.querySelector("#" + who + "_suggestions");
            el.style.height = "0px";
            el.style.border = "0px";
         }
      });
   }
}
window.addEventListener("load", init);
</script>
</body>
</html>
