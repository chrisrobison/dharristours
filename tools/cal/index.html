<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='main.css' rel='stylesheet' />
<link href='/lib/css/tiny-date-picker.css' rel='stylesheet' />
<script src='/lib/js/tiny-date-picker.min.js'></script>
<script src='mycal.js'></script>
<script>
  var calendar;
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    calendar = new FullCalendar.Calendar(calendarEl, {
      plugins: [ 'interaction', 'resourceDayGrid', 'resourceTimeGrid' ],
      defaultView: 'resourceTimeGridDay',
      defaultDate: new Date().toISOString().substr(0, 10),
      editable: true,
      selectable: true,
      eventLimit: true,
      eventLimit: true, // allow "more" link when too many events
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'resourceTimeGridDay,resourceTimeGridTwoDay,timeGridWeek,dayGridMonth'
      },
      views: {
        resourceTimeGridTwoDay: {
          type: 'resourceTimeGrid',
          duration: { days: 2 },
          buttonText: '2 days',
        }
      },
      //// uncomment this line to hide the all-day slot
      allDaySlot: false,

      resources: {
         url: "get-resources.php"
      },
      events: {
         url: "get-events.php"
      },

      select: function(arg) {
        console.log(
          'select',
          arg.startStr,
          arg.endStr,
          arg.resource ? arg.resource.id : '(no resource)'
        );
      },
      dateClick: function(arg) {
        console.log(
          'dateClick',
          arg.date,
          arg.resource ? arg.resource.id : '(no resource)'
        );
      }
    });

    calendar.render();
  });

</script>
<style>

  body {
    margin: 0;
    padding: 0;
    font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
    font-size: 14px;
  }

  #calendar {
    max-width: 60%;
    margin: .5em auto 0px auto;
    display:inline-block;
  }
  .left {
     position:relative; 
     width:400px;
     display:inline-block;
     float:left;
     margin-top:0em;
     margin-right:1em;
  }
  #tinycal {
    width:400px;
  }
  #details {
     display:inline-block;
     width:400px;
     height:25em;
     margin:.5em 0 1em 0;
     border:1px solid #ccc;
     padding:0px;
  }
  #detail {
    overflow-y:scroll;
    position:relative;
    height:20em;

  }
  .fc-scroller { height:48em !important; }
  .dp-col-header, .dp-permanent {
     font-size:1em;
  }
  .dp-day, .dp-today {
     font-size:22px;
  }
  #details h1 { 
   text-align:center;
   margin:0;
   background-color:#f5f5f5;
   font-weight:normal;
   padding:.5em .5em;
   min-width:5em;
   font-size:1.7em;
   display:inline-block;
  }
  #jobdetail th {
    text-align: right;
    padding: .3em;
    border-right: 1px solid #ccc;
    vertical-align:top;
    font-weight:normal;
  }
  #jobdetail td {
   padding:.3em;
   vertical-align:top;
  }
  #jobdetail {
   border-collapse:collapse;
   max-height:100%;
   font-size:1.2em;
   line-height:1.5em;
   overflow-y: scroll;
  }
  .left {
    
  }
.tabs{
  overflow:hidden;
  clear:both;

}
.tabs ul{
  list-style-type:none;
  bottom: -1px;
  position:relative;
}
.tabs li{
  float:left;
}

.tabs a{
  display:block;
  padding:5px 10px;
  background-color: #EEE;
  color: #000;
  text-decoration: none;
  margin: 0 4px;
  border-top:1px solid #CCC;
  border-left:1px solid #DDD;
  border-right:1px solid #DDD;
  font:13px/18px verdana,arial,sans-serif;
  border-bottom:1px solid #CCC;
}
.tabs a.active{
  background-color: #fff;
  border-bottom:1px solid #fff;
}
.tabs div{
  clear: both;
  border:1px solid #CCC;
  padding:5px;
  font-family:verdana;
  font-size:13px;
  background-color: #fff;
  display:none;
}
</style>
</head>
<body>
<div class='left'>
  <div id='tinycal'></div>
  <div id='details' class='tabs'>
      <ul>
        <li><a href="#jobs" >Jobs</a></li> 
        <li><a href="#detail" class="active">Details</a></li> 
      </ul>

      <div id='jobs'> </div>
      <div id='detail'> </div>
   </div>
</div>
  <div id='calendar'></div>
<script>
   var dpPermanent = TinyDatePicker('#tinycal', { mode: 'dp-permanent', });
   dpPermanent.on('statechange', (_, picker) => { 
      console.log(picker.state.hilightedDate.toISOString()); 
      calendar.gotoDate(picker.state.hilightedDate.toISOString()); 

   } );

   function handleClick(who) { 
      
      makeRequest('GET', 'get-event.php?id='+who, function (err, datums) {
        myevent = JSON.parse(datums);
        console.dir(myevent);

        var out = "<table id='jobdetail'><tr><th>Job ID</th><td>" + myevent.JobID + "</td>";
        out += "<th>Passengers</th><td>" + ((myevent.NumberOfItems) ? myevent.NumberOfItems : "?") + "</td></tr>";
        out += "<tr><th>Job</th><td colspan='3'>"+myevent.Job+"</td></tr>";
        out += "<tr><th>Bus</th><td colspan='3'>" + mybuses[myevent.BusID].title + "</td></tr>";
        
        var driver = (myevent && myevent.EmployeeID && mydrivers && mydrivers[myevent.EmployeeID]) ? mydrivers[myevent.EmployeeID].Driver + " - " + mydrivers[myevent.EmployeeID].Phone : "Unassigned";
      
        out += "<tr><th>Driver</th><td colspan='3'>" + driver + "</td></tr>";
        out += "<tr><th>Pickup</th><td colspan='2'>"+ ((myevent.PickupLocation) ? myevent.PickupLocation : "") +"</td><td>" +myevent.PickupTime + "</td></tr>";
        out += "<tr><th>Dropoff</th><td colspan='2'>"+ ((myevent.DropOffLocation) ? myevent.DropOffLocation : "") +"</td><td>" +myevent.DropOffTime + "</td></tr>";
        if (myevent.finalDropOffLocation) {
         out += "<tr><th>Final</th><td colspan='2'>"+myevent.FinalDropOffLocation +"</td></tr>";
        }
        out += "</table>";

        document.querySelector("#detail").innerHTML = out;
        if (err) { throw err; }
        console.log(datums);
      }); 
   } 
   function makeRequest (method, url, done) {
     var xhr = new XMLHttpRequest();
     xhr.open(method, url);
     xhr.onload = function () {
       done(null, xhr.response);
     };
     xhr.onerror = function () {
       done(xhr.response);
     };
     xhr.send();
   }
   var buses, myevent, drivers, mybuses = {}, mydrivers = {};

   makeRequest('GET', 'get-resources.php', function (err, data) {
      buses = JSON.parse(data);
      for (var i=0; i<buses.length; i++){
         mybuses[buses[i].busID] = buses[i];
      }
      console.log("Buses:");
      console.dir(mybuses);
   });
   
   makeRequest('GET', 'get-drivers.php', function (err, data) {
      drivers = JSON.parse(data);
      for (var i=0; i<drivers.length; i++){
         mydrivers[drivers[i].EmployeeID] = drivers[i];
      }
      console.log("Drivers:");
      console.dir(mydrivers);
   });

function makeTabs(selector) {
 
    tab_lists_anchors = document.querySelectorAll(selector + " li a");
    divs = document.querySelector(selector).getElementsByTagName("div");
    for (var i = 0; i < tab_lists_anchors.length; i++) {
        if (tab_lists_anchors[i].classList.contains('active')) {
            divs[i].style.display = "block";
        }
 
    }
 
    for (i = 0; i < tab_lists_anchors.length; i++) {
 
        document.querySelectorAll(".tabs li a")[i].addEventListener('click', function(e) {
 
            for (i = 0; i < divs.length; i++) {
                divs[i].style.display = "none";
            }
 
            for (i = 0; i < tab_lists_anchors.length; i++) {
                tab_lists_anchors[i].classList.remove("active");
            }
 
            clicked_tab = e.target || e.srcElement;
 
            clicked_tab.classList.add('active');
            div_to_show = clicked_tab.getAttribute('href');
 
            document.querySelector(div_to_show).style.display = "block";
 
        });
    }
}
window.addEventListener("load", function() {
    makeTabs(".tabs")
});
</script>
</body>
</html>
