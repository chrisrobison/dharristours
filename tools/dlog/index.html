<!DOCTYPE html> 
<html>
<head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Daily Driver Log</title>
   <link href="//fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
   <link href='/lib/css/tiny-date-picker.css' rel='stylesheet'>
   <link href='main.css' rel='stylesheet'>
   <script src='/lib/js/tiny-date-picker.min.js'></script>
</head>
<body>
<div id='main'>
   <div id='form'>
      <label for='driver'>Driver:</label>
      <select id='driver'> </select> &nbsp; 
      <label for='date'>Date:</label>
      <input type='text' id='date' size='10' class='is-below'>
      <button id='lookup'>&#x1f50d; Lookup</button>
   </div>
   <div id='wrap'>
      <div id='topform'>
         <table class='topform'>
            <tr>
               <td id='perf' colspan='4'>&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;</td>
            </tr>
            <tr><td><br></td></tr>
            <tr>
               <td><h1 style='display:inline-block;'>DRIVER'S DAILY LOG</h1>
               <table>
                  <tr><th class='label'><label>Pickup:</label></td><td><span class='topval' id='logpickup'></span></td></tr>
                  <tr><th class='label'><label>Drop-off:</label></td><td><span class='topval' id='logdropoff'></span></td></tr>
               </table>
               </td>
               <td>
               <table>
                  <tr><th class='label'><label>Date:</label></td><td><span class='topval' id='logdate'></span></td></tr>
                  <tr><th class='label'><label>Driver:</label></td><td><span class='topval' id='logdriver'></span></td></tr>
                  <tr><th class='label'><label>Bus #:</label></td><td><span class='topval' id='busno'></span></td>
               </tr></table></td>
               <td>&nbsp;</td>
               <td class='carrier' rowspan=3><img src='path851.png' style='float:left;height:75px;position:relative;top:.25em;left:.5em;padding-right:1em;'><span style='padding-right:.25em;'>D Harris Tours<br>153 Utah St.<br>SSF, CA 94080 </span></td>
            </tr>
         </table>
      </div>
      <table id='hoursTable' class='timetable'>
      </table> 
      <div class='notes'><label>Job ID:</label> <span id='jobid'></span></div>
   </div>
</div>
</body>
<script type='text/javascript'>
   
(function(win, doc) {
   const dlog = {
      config: {
         workStates: ['Off Duty', 'Sleeper', 'Driving', 'On Duty', 'Remarks']
      },
      init: function() {
         dlog.buildTimeTable();
         dlog.calendar = TinyDatePicker(document.querySelector('#date'), {
            mode: 'dp-below',
          });
         
         var drvr = document.querySelector("#driver");
         drvr.addEventListener("change", function(e) {
            if (document.querySelector("#date").value!="") {
               dlog.buildTimeTable();
               dlog.fetchJobs(e);
            }
         });

         document.querySelector('#date').addEventListener("change", function(e) {
            var drvr = document.querySelector("#driver");
            if (drvr.selectedIndex) {
               dlog.buildTimeTable();
               dlog.fetchJobs(e);
            }

         });
         
         fetch("api.php?type=drivers").then((response) => {
            return response.json();
         }).then((data) => {
            var out = "<option value=''>-- Select Driver --</option>";
            for (var i=0; i<data.length; i++) {
               out += "<option value='" + data[i].EmployeeID + "'>"+data[i].Driver+"</option>";
            }
            document.querySelector("#driver").innerHTML = out;
         });
         
         var btn = document.querySelector("#lookup");
         btn.addEventListener("click", function(e) {
            dlog.buildTimeTable();
            dlog.fetchJobs(e);
            e.preventDefault();
            return false;
         });
      },
      fetchJobs: function(e) {
         var drvr = document.querySelector("#driver");
         var driver = drvr.options[drvr.selectedIndex].value;
         var mydate = document.querySelector("#date").value;
          
         if (driver && mydate) {
            $("#logdate").innerHTML = new Date(mydate).toLocaleDateString();
            $("#logdriver").innerHTML = drvr.options[drvr.selectedIndex].text;
            fetch("api.php?type=jobs&EmployeeID="+driver+"&jobdate="+mydate).then((response) => {
               return response.json();
            }).then((data) => {
               var last = 0, x, y;
               $("#busno").innerHTML = data[0]['busnum'];
               $("#logpickup").innerHTML = data[0]['pickup'];
               $("#logdropoff").innerHTML = data[data.length-1]['dropoff'];
               $("#jobid").innerHTML = data[0]['id'];
               var tots = {OffDuty:0, Sleeper:0, Driving:0, OnDuty:0, Remarks:0};
               for (var i=0; i<data.length; i++) {
                  x = new Date(data[i]['start']);
                  y = new Date(data[i]['end']);
                  for (var k=last; k<x.getHours(); k++) {
                     var worktype = (last) ? "OnDuty" : "OffDuty";
                     tots[worktype]++;
                     tots['Remarks']++;
                     dlog.setHour(worktype, k, "Not Driving");
                  }
                  for (var j=x.getHours(); j<y.getHours(); j++) {
                     if (j < y.getHours()-1) {
                        tots['Driving']++;
                        tots['Remarks']++;
                        dlog.setHour('Driving', j, data[i].pickup); 
                     } else {
                        tots['Driving']++;
                        tots['Remarks']++;
                        dlog.setHour('Driving', j, data[i].dropoff);
                     }
                  }
                  last = y.getHours();
               }

               for (var k=last; k<24; k++) {
                  tots['OffDuty']++;
                  tots['Remarks']++;
                  dlog.setHour("OffDuty", k, "Not Driving");
               }

               for (var i in dlog.config.workStates) {
                  var wstxt = dlog.config.workStates[i];
                  wstxt = wstxt.replace(/\s*/g, '');
                  
                  var el = $("#" +  wstxt + "_total");
                  if (el) {
                     el.innerHTML = tots[wstxt];
                  }
               }
            });
         }
      },
      buildTimeTable: function() {
         var workstate, out='', foot='';

         // Handle headers and footers first
         out += "<thead><tr><th class='blank'></th>";
         foot += "<tr class='tfoot'><th class='blank'></th>";
         for (var c=0; c<24; c++) {
            if ((c ) === 0) {
               t = "12a";
            } else if ((c ) === 12) {
               t = "12p";
            } else {
               t = c % 12;
            }
            out += "<th>" + t + "</th>";
            foot += "<th>" + t + "</th>";
         }
         foot += "<th></th><th class='totalhours'><div id='totalhours'></div></th></tr>";
         out += "<th></th><th class='totalhours'>Total<br>Hours</th></tr></thead>\n";
         
         // Now generate timelines for each dlog.conf.workStates
         out += "<tbody>";
         var wsCount = dlog.config.workStates.length;
         for (var i=0; i < wsCount; i++) {
            out += "<tr>";
            workstate = dlog.config.workStates[i];
            wrk = workstate.replace(/\W/, '');
            out += "<th>" + (i + 1) + ". " + workstate + "</th>";

            for (var j=0; j < 24; j++) {
               out += "<td id='" + wrk + "_" + j + "'></td>";
            }
            out += "<td colspan='2' class='totalhours'><div id='" + wrk + "_total' class='total'></div></td>";
            out += "</tr>\n";

            console.log("dlog.config.workStates.length: "+wsCount);
            if (i == (wsCount - 2)) {
               out += foot;
            }
         }
         out += "</tbody>";

         var hours = document.querySelector('#hoursTable');
         hours.innerHTML = out;
         console.log(out);
         return out;
      },
      lastHourRemark: '',
      setHour: function(type, hour, val) {
         var cell = document.querySelector("#"+type+"_"+hour);

         if (cell) {
            cell.innerHTML = "<div class='line' title='" + val + "'></div>";
         }

         val = val.replace(/\(?\d\d\d\)?[\-\s]?\d\d\d\-\d\d\d\d/, '');
         var city = dlog.guessCity(val);
         if (dlog.lastHourRemark != val) {
            var remarkCell = document.querySelector("#Remarks_"+hour);
            if (remarkCell) {
               if (val!= "Not Driving") {
                  remarkCell.innerHTML = "<div class='remark'>" + city + ", CA</div>";
               }
            }
            dlog.lastHourRemark = val;
         }
      },
      guessCity: function(addr) {
         var cities = ['South San Francisco', 'San Francisco', 'San Rafael', 'Vallejo', 'San Ramon', 'Castro Valley', 'Loma Mar', 'Alameda', 'Oakland', 'Sausalito', 'Elk Grove', 'Walnut Creek', 'Berkeley', 'Rocklin', 'Atherton', 'Brentwood', 'Folsom', 'Pacifica', 'Morgan Hill', 'Burlingame', 'Lagunita', 'El Cerrito', 'Richmond', 'Monterey', 'Montara', 'Concord', 'Pleasanton', 'Windsor', 'Corte Madera', 'Oakville', 'Mill Valley', 'Daly City', 'Vacaville', 'Union City', 'Merced', 'San Mateo', 'Palo Alto', 'Hayward', 'Livermore', 'Santa Clara', 'Sunnyvale', 'San Carlos', 'Redwood City', 'San Leandro', 'Pleasant Hill', 'Hercules', 'Eureka', 'Marin City', 'Danville', 'Alviso', 'Pittsburgh', 'Rohnert Park', 'San Lorenzo', 'Half Moon Bay', 'San Pablo', 'Dublin', 'Larkspur', 'Davis', 'Sacramento', 'Lafayette', 'Ross', 'Pittsburg', 'Menlo Park', 'Novato', 'Arbuckle', 'San Jose', 'Kentfield', 'Fremont', 'Piedmont', 'Boulder Creek', 'Healdsburg', 'Fairfax', 'Milpitas', 'Martinez', 'Aptos', 'Fairfield', 'Orinda', 'Antioch', 'Oakley', 'Pinole', 'Clayton', 'Greenbrae', 'Lotus', 'Dixon', 'Stockton', 'Albany', 'Emeryville', 'Cazadoro', 'El Sobrante', 'Oakhurst', 'Stanford', 'Nicasio', 'Suisun City', 'Napa', 'Tomales', 'Newark', 'Modesto', 'Santa Rosa', 'Turlock', 'Pescadero', 'Santa Cruz', 'Groveland', 'Tiburon', 'Crockett', 'Sonoma', 'Brisbane', 'Mountain House', 'Mt House', 'Tracy', 'Moraga', 'Los Altos', 'Fresno', 'San Bruno', 'Petaluma', 'Benecia', 'Gilroy', 'Sausilito', 'Stinson Beach', 'Felton', 'San Gregorio', 'Mountain View', 'Mt View', 'Mt. View', 'Millbrae', 'Milbrae', 'Rodeo', 'Clarksberg', 'Alamo', 'Marysville', 'Yuba City', 'Belmont', 'Inverness'];
         var re, city='';

         for (var i=0; i<cities.length; i++) {
            re = new RegExp(cities[i], 'i');
            if (re.exec(addr)) {
               city = cities[i];
               i = cities.length;
            }
         }
         return city;
      }

   };

   window.dlog = dlog;
   window.addEventListener('load', function() {
      dlog.init();
   });

})(window, document);
function $(str) {
   return document.querySelector(str);
}
</script>
</html>
