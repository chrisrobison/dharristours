<!DOCTYPE html>
<html>
  <head>
    <title>Realtime Bus Locations</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <style>
       @import url('https://fonts.googleapis.com/css?family=Roboto&display=swap');
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
        width:80%;
        float:right;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-size:15px;
        font-family: 'Roboto', sans-serif;
      }
      h2 {
         padding-bottom:0px;
         margin-bottom:.25em;
         margin-top:.125em;
      }
      .labels { 
         background-color:#ffffff;
         padding:.25em;
         display:inline-block;
         border:.5em solid yellow;
      }
      .time {
         text-align:right;
      }
      .locations {
         border-collapse: collapse;
         border:0px;
         width:100%;
      }
       .details {
         border-collapse: collapse;
         border:1px solid #ccc;
         width:100%;
      }
      td, th {
         padding:.5em;

      }
      .subtable {
         margin:0px;
         padding:0px;
         font-size:.8em;
      }
      .subtable th {
         text-align:right;
         width:4em;
      }
      #buses {
         height: 8em;
         overflow-y:scroll;
         display:inline-block;
         padding:0px .25em;
         margin:0px;
         background-color:#fff;
         border:1px inset #eee;
      }
      .label {
         display:inline-block;
         vertical-align:top;
         padding:.25em;
      }
      #buses li {
         display:block; 
         font-weight:100;
         width:8em;
      }
      #startdate {
         display:inline-block;
         vertical-align:top;
      }
      #toolbar {
         padding:.25em;
         background-color:#eee;
         height:50%;
         width:20%;
      }
      .daterangepicker .drp-calendar { max-width:1000px !important; }
      #when { 
         font-size: 16px;
         padding:3px;
         width:12em;
      }
      #startdate button::before {
         content: "â–º";
         position:absolute;
      }
      #startdate button {
         height:2.4em;
         width:2.7em;

      }
      #player button {
         border:0;
         padding:0;
         margin:0;
         font-size:2em; 
         background-color:transparent;
      }
      #player {
         white-space:nowrap;
      }
      button:active {
         position:relative;
         top:2px;
      }
      button:focus {
         outline:none;
      }
    </style>
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

   <script defer src="/where/markerclustererplus.min.js"></script>  
   <script defer src="/where/showwhen.js"> </script>
  </head>
  <body>
    <div id="map"></div>
    <div id="toolbar">
      <span class='label'>Buses: </span>
      <ul id='buses'>
         <li><input id='allbuses' type='checkbox' name='buses' value='' checked='checked'> All buses</li>
         <li><input type='checkbox' name='buses' value='2302'> Bus# 2302</li>
         <li><input type='checkbox' name='buses' value='2502'> Bus# 2502</li>
         <li><input type='checkbox' name='buses' value='2503'> Bus# 2503</li>
         <li><input type='checkbox' name='buses' value='2802'> Bus# 2802</li>
         <li><input type='checkbox' name='buses' value='3301'> Bus# 3301</li>
         <li><input type='checkbox' name='buses' value='3601'> Bus# 3601</li>
         <li><input type='checkbox' name='buses' value='3801'> Bus# 3801</li>
         <li><input type='checkbox' name='buses' value='4001'> Bus# 4001</li>
         <li><input type='checkbox' name='buses' value='4402'> Bus# 4402</li>
      </ul>
      <br>
      <br>
      <div id='startdate'><span class='label'>Date Range:</span><br><input id='when' type='datetime'><button onclick="getPath(mystart, myend)"> &gt; </button></div>
      <input type='range' min='0' max='100' step='.1' id='timeslice' value='0'>
      <div id='player'>
         <button id='ts_0'>&#9198;</button><button id='ts_-1'>&#9194;</button><button id='ts_play'>&#9199;</button><button id='ts_+1'>&#9193;</button><button id='ts_100'>&#9197;</button>
      </div>
    </div>
    <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFP8KaKNAWOcD0iXL40U5VaKU0ZhY-oCA&callback=initMap"> </script>
    <script>
      window.mystart = new moment(new Date().getTime() - 86400000).format("YYYY-MM-DD HH:mm:ss");
      window.myend = new moment(new Date().getTime()).format("YYYY-MM-DD HH:mm:ss");
      
      var btns = document.querySelectorAll("#player button");
      for (var i=0; i<btns.length; i++) {
         btns[i].addEventListener("click", handleClick);
      }
      
      function fireEvent(el, type) {
         if ("createEvent" in document) {
             var evt = document.createEvent("HTMLEvents");
             evt.initEvent(type, false, true);
             el.dispatchEvent(evt);
         }
         else {
             el.fireEvent("on" + type);
         }
      }
      window.simpleAdvance = .1;
      function nextStep() {
         var slider = document.querySelector("#timeslice");
         slider.value = parseFloat(slider.value) + window.simpleAdvance;
         if (slider.value >= 100) {
            window.simpleAdvance = -.1;
            slider.value = 99.9;
         } else if (slider.value <= 0) {
            window.simpleAdvance = .1;
            slider.value += window.simpleAdvance;
         }
         fireEvent(slider, 'change');
         if (window.playing) {
            window.playTimeout = setTimeout(nextStep, 20);
         }
      }
      function handleClick(e) {
         var slider = document.querySelector("#timeslice");
         console.log("handling Click");
         var action = e.target.id.replace(/^ts_/, '');
         console.log(action);
         switch(action) {
            case "play":
               if (window.playing) {
                  window.playing = 0;
               } else {
                  window.playing = 1;
                  window.playTimeout = setTimeout(nextStep, 500);
               }
            break;
            case "+1":
               slider.value = parseInt(slider.value) + 1;
               fireEvent(slider, 'change');
               break;
            case "-1":
               slider.value = slider.value - 1;
               fireEvent(slider, 'change');
               break;
            case "0":
               slider.value = 0; 
               fireEvent(slider, 'change');
               break;
            case "100":
               slider.value = 100;
               fireEvent(slider, 'change');
            break;
         }
      }

      $('#when').daterangepicker({
         "timePicker":true,
          "timePicker24Hour": true,
          "autoApply": true,
          "alwaysShowCalendars": true,
          "startDate": new moment(new Date().getTime() - 86400000),
          "endDate": new moment(new Date().getTime())
          }, function(start, end, label) {
         window.mystart = start.format("YYYY-MM-DD HH:mm:ss");;
         window.myend = end.format("YYYY-MM-DD HH:mm:ss");
         getPath(mystart, myend);
        console.log('New date range selected: ' + start.format('YYYY-MM-DD hh:mm') + ' to ' + end.format('YYYY-MM-DD hh:mm') + ' (predefined range: ' + label + ')');
      });
    </script>
  </body>
</html>

